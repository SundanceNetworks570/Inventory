<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>In-House Inventory Tracker</title>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#9aa3b2; --text:#e6e9ef; --line:#232839;
      --good:#86efac; --warn:#fde68a; --bad:#fca5a5;
      --input:#0d0f14; --btn:#111827; --btnText:#e6e9ef; --accent:#0ea5e9; --accentText:#001018;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --muted:#5b6474; --text:#0b1220; --line:#e5e7ef;
      --good:#16a34a; --warn:#b45309; --bad:#dc2626;
      --input:#ffffff; --btn:#f1f5f9; --btnText:#0b1220; --accent:#2563eb; --accentText:#ffffff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    header{padding:18px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:2}
    h1{margin:0 0 6px;font-size:18px;font-weight:700;}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px 20px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1 1 auto}
    input,select{
      background:var(--input);color:var(--text);border:1px solid var(--line);border-radius:7px;padding:7px 8px;font-size:13px;outline:none;
    }
    input::placeholder{color:#667085}
    button{
      background:var(--btn);color:var(--btnText);border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:13px;cursor:pointer;
      transition:.15s transform,.15s border-color;
    }
    button:hover{transform:translateY(-1px);border-color:#94a3b8}
    button.primary{background:linear-gradient(180deg,var(--accent),#0284c7);border-color:var(--accent);color:var(--accentText);font-weight:700}
    button.warn{background:color-mix(in oklab, var(--warn) 30%, var(--btn));border-color:color-mix(in oklab, var(--warn) 60%, var(--line));}
    button.bad{background:color-mix(in oklab, var(--bad) 25%, var(--btn));border-color:color-mix(in oklab, var(--bad) 60%, var(--line));}
    button.tinybtn{padding:4px 6px;font-size:11px;border-radius:6px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{color:var(--muted);font-weight:600;text-align:left;font-size:12px;padding:0 8px;white-space:nowrap;}
    td{background:var(--input);border:1px solid var(--line);padding:8px;border-right:0;border-left:0}
    td:first-child{border-left:1px solid var(--line);border-top-left-radius:9px;border-bottom-left-radius:9px}
    td:last-child{border-right:1px solid var(--line);border-top-right-radius:9px;border-bottom-right-radius:9px}
    .pill{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .badge-low{color:var(--accentText);background:var(--warn);font-weight:700;border:0}
    .badge-out{color:var(--accentText);background:var(--bad);font-weight:700;border:0}
    .badge-ok{color:var(--accentText);background:var(--good);font-weight:700;border:0}
    .tiny{font-size:11px;color:var(--muted)}
    .nowrap{white-space:nowrap}
    a.buy{color:var(--accentText);background:var(--accent);padding:4px 8px;border-radius:6px;text-decoration:none;font-weight:700;font-size:12px;display:inline-block}
    a.buy:hover{opacity:.9}
    .status{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background:var(--input);color:var(--muted);
    }
    .status.ok{color:var(--good);border-color:color-mix(in oklab, var(--good) 60%, var(--line));}
    .status.warn{color:var(--warn);border-color:color-mix(in oklab, var(--warn) 60%, var(--line));}
    .status.bad{color:var(--bad);border-color:color-mix(in oklab, var(--bad) 60%, var(--line));}
  </style>
</head>
<body>
<header>
  <h1>In-House Inventory Tracker</h1>
  <div class="sub">
    Backed by Google Sheets (auto-sync). LocalStorage used only as offline fallback.
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <input id="searchInput" placeholder="Search SKU, item, category, vendor..." style="flex:1;min-width:220px">

      <label class="tiny">Vendor</label>
      <select id="vendorFilter" style="width:160px"></select>

      <label class="tiny">Category</label>
      <select id="categoryFilter" style="width:160px"></select>

      <label class="tiny">On-hand</label>
      <select id="onHandFilter" style="width:150px">
        <option value="all">All</option>
        <option value="in">In Stock</option>
        <option value="low">Low</option>
        <option value="out">Out</option>
        <option value="unknown">Unknown</option>
      </select>

      <label class="tiny">Low-stock threshold</label>
      <input id="lowStockInput" type="number" value="1" style="width:70px">

      <div class="spacer"></div>

      <span id="cloudStatus" class="status">Loading cloud‚Ä¶</span>

      <button class="primary" id="addRowBtn">+ Add New Item</button>

      <button id="downloadJsonBtn">Download JSON</button>
      <button id="importJsonBtn">Import JSON</button>
      <input id="importJsonInput" type="file" accept="application/json" style="display:none" />

      <button id="themeToggleBtn">üåô Dark</button>

      <button class="warn" id="saveBtn">Save (Local)</button>
      <button id="exportCsvBtn">Export CSV</button>
      <button class="primary" id="downloadHtmlBtn">Download HTML w/ Data</button>
      <button class="bad" id="resetBtn">Reset All</button>
    </div>
    <div class="tiny" id="countLabel" style="margin-top:6px;"></div>
  </section>

  <section class="card">
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Item</th>
            <th>Category</th>
            <th>Vendor</th>
            <th>Purchase</th>
            <th>Qty On-Hand</th>
            <th>Notes</th>
            <th>Last Order</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/** ============ CONFIG ============ */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyUESmreudRxEbw0Bim9y1MUU7f8Gk0qNKpmiFHwVsa2fED4VK_PsdCR0_caPlXvtr76Q/exec";

/** ============ SEED (fallback only) ============ */
let inventory = []; // cloud overwrites on load
let vendors = ["BH Photo","Amazon","Microsoft","CDW","New Egg","Tiger Direct","D and H"];
let categories = [
  "Networking","GPU","Camera","Laptop","Scanner",
  "Cabling","Adapters","Peripherals","Power","Storage",
  "Hardware & Install","Printing","Security","Audio/Video"
];

const STORAGE_KEY_ITEMS      = "bhinv_items_cloud_v2";
const STORAGE_KEY_VENDORS    = "bhinv_vendors_cloud_v2";
const STORAGE_KEY_CATEGORIES = "bhinv_categories_cloud_v2";
const STORAGE_KEY_THEME      = "bhinv_theme_cloud_v2";

const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").toString().toLowerCase().trim();

/** ===== Cloud status pill ===== */
function setStatus(text, cls=""){
  const el = $("cloudStatus");
  el.textContent = text;
  el.className = "status " + cls;
}

/** ===== Stable IDs ===== */
function ensureIds(){
  inventory = inventory.map(it=>{
    if(it._id) return it;
    const salt = Math.random().toString(36).slice(2,8);
    return {...it, _id: `${it.sku||"item"}-${salt}`};
  });
}

/** ===== Local fallback load/save ===== */
function loadLocalFallback(){
  try{
    const vraw = localStorage.getItem(STORAGE_KEY_VENDORS);
    if(vraw){ vendors = JSON.parse(vraw) || vendors; }
  }catch(e){}
  try{
    const craw = localStorage.getItem(STORAGE_KEY_CATEGORIES);
    if(craw){ categories = JSON.parse(craw) || categories; }
  }catch(e){}
  try{
    const raw = localStorage.getItem(STORAGE_KEY_ITEMS);
    if(raw){ inventory = JSON.parse(raw)||inventory; }
  }catch(e){}
}

function saveLocal(renderAfter=false){
  localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(inventory));
  localStorage.setItem(STORAGE_KEY_VENDORS, JSON.stringify(vendors));
  localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
  if(renderAfter) { buildFilterOptions(); render(); }
}

/** ===== CLOUD: JSONP GET (CORS-safe) ===== */
function loadFromSheet(){
  return new Promise((resolve)=>{
    setStatus("Loading cloud‚Ä¶");

    const cbName = "sheetCallback_" + Math.random().toString(36).slice(2);
    window[cbName] = (data)=>{
      try{
        if(!data.ok) throw new Error(data.error || "Cloud load failed");

        inventory = Array.isArray(data.items) ? data.items : [];
        vendors = (Array.isArray(data.vendors) && data.vendors.length) ? data.vendors : vendors;
        categories = (Array.isArray(data.categories) && data.categories.length) ? data.categories : categories;

        ensureIds();
        saveLocal(false);
        setStatus("Saved to cloud ‚úÖ", "ok");
        resolve(true);
      }catch(err){
        console.warn(err);
        setStatus("Cloud offline ‚Äî using local", "warn");
        loadLocalFallback();
        ensureIds();
        resolve(false);
      }finally{
        delete window[cbName];
        script.remove();
      }
    };

    const script = document.createElement("script");
    script.src = `${SHEET_API_URL}?callback=${cbName}&_=${Date.now()}`;
    script.onerror = ()=>{
      setStatus("Cloud offline ‚Äî using local", "warn");
      loadLocalFallback();
      ensureIds();
      resolve(false);
      delete window[cbName];
      script.remove();
    };
    document.body.appendChild(script);
  });
}

/** ===== CLOUD: POST with no-cors ===== */
async function saveToSheet(){
  try{
    setStatus("Saving‚Ä¶");
    const payload = { items: inventory, vendors, categories };

    await fetch(SHEET_API_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    setStatus("Saved to cloud ‚úÖ","ok");
    return true;
  }catch(err){
    console.warn(err);
    setStatus("Cloud save failed ‚Äî local only","bad");
    return false;
  }
}

/** Debounced autosave */
let saveTimer = null;
function scheduleCloudSave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    saveLocal(false);
    saveToSheet();
  }, 1200);
}

/** ===== Theme ===== */
function loadTheme(){
  const t = localStorage.getItem(STORAGE_KEY_THEME) || "dark";
  document.documentElement.setAttribute("data-theme", t);
  updateThemeButton();
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  const next = cur === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem(STORAGE_KEY_THEME, next);
  updateThemeButton();
}
function updateThemeButton(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  $("themeToggleBtn").textContent = cur === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
}

/** ===== Purchase URL builder ===== */
function getPurchaseUrl(it){
  if(it.purchaseUrl && it.purchaseUrl.trim()) return it.purchaseUrl.trim();
  const q = encodeURIComponent(it.sku || it.name || "");
  const v = norm(it.vendor);
  if(v.includes("bh"))          return `https://www.bhphotovideo.com/c/search?Ntt=${q}`;
  if(v.includes("amazon"))      return `https://www.amazon.com/s?k=${q}`;
  if(v.includes("microsoft"))   return `https://www.microsoft.com/en-us/search/shop?q=${q}`;
  if(v.includes("cdw"))         return `https://www.cdw.com/search/?key=${q}`;
  if(v.includes("new egg") || v.includes("newegg"))
                               return `https://www.newegg.com/p/pl?d=${q}`;
  if(v.includes("tiger"))       return `https://www.tigerdirect.com/applications/SearchTools/search.asp?keywords=${q}`;
  if(v.includes("d and h") || v.includes("d&h") || v.includes("dandh"))
                               return `https://www.dandh.com/search?q=${q}`;
  const fallback = encodeURIComponent(`${it.vendor||"vendor"} ${it.sku||""} ${it.name||""}`);
  return `https://www.google.com/search?q=${fallback}`;
}

function stockBadge(qty){
  const low = Number($("lowStockInput").value || 1);
  const n = Number(qty);
  if(qty==="" || isNaN(n)) return `<span class="pill">‚Äî</span>`;
  if(n <= 0) return `<span class="pill badge-out">OUT</span>`;
  if(n <= low) return `<span class="pill badge-low">LOW</span>`;
  return `<span class="pill badge-ok">OK</span>`;
}

function vendorOptions(selected){
  const opts = vendors.map(v=>{
    const sel = (v===selected) ? "selected" : "";
    return `<option value="${v}" ${sel}>${v}</option>`;
  }).join("");
  return opts + `<option value="__add_vendor__">+ Add vendor...</option>`;
}
function categoryOptions(selected){
  const opts = categories.map(c=>{
    const sel = (c===selected) ? "selected" : "";
    return `<option value="${c}" ${sel}>${c}</option>`;
  }).join("");
  return opts + `<option value="__add_category__">+ Add category...</option>`;
}

/** ===== Filters ===== */
function buildFilterOptions(){
  const vSel = $("vendorFilter").value || "all";
  const cSel = $("categoryFilter").value || "all";

  $("vendorFilter").innerHTML =
    `<option value="all">All</option>` +
    vendors.map(v=>`<option value="${v}">${v}</option>`).join("");

  $("categoryFilter").innerHTML =
    `<option value="all">All</option>` +
    categories.map(c=>`<option value="${c}">${c}</option>`).join("");

  $("vendorFilter").value = vSel;
  $("categoryFilter").value = cSel;
}

function addVendorFlow(selectEl){
  const nv = prompt("Enter new vendor name:");
  if(!nv) { selectEl.value = (inventory.find(x=>x._id===selectEl.dataset.id)?.vendor)||""; return; }
  const clean = nv.trim();
  if(!clean) return;
  if(!vendors.some(v=>norm(v)===norm(clean))) vendors.push(clean);
  selectEl.value = clean;
  const idx = inventory.findIndex(x=>x._id===selectEl.dataset.id);
  if(idx>-1) inventory[idx].vendor = clean;
  buildFilterOptions();
  scheduleCloudSave();
}

function addCategoryFlow(selectEl){
  const nc = prompt("Enter new category name:");
  if(!nc) { selectEl.value = (inventory.find(x=>x._id===selectEl.dataset.id)?.category)||""; return; }
  const clean = nc.trim();
  if(!clean) return;
  if(!categories.some(c=>norm(c)===norm(clean))) categories.push(clean);
  selectEl.value = clean;
  const idx = inventory.findIndex(x=>x._id===selectEl.dataset.id);
  if(idx>-1) inventory[idx].category = clean;
  buildFilterOptions();
  scheduleCloudSave();
}

function setDirectLink(id){
  const idx = inventory.findIndex(x=>x._id===id);
  if(idx<0) return;
  const current = inventory[idx].purchaseUrl || "";
  const url = prompt("Paste a direct product URL for this item (leave blank to clear):", current);
  if(url === null) return;
  inventory[idx].purchaseUrl = (url||"").trim();
  scheduleCloudSave();
}

/** Add blank row */
function addNewItem(){
  const vFilter = $("vendorFilter").value || "all";
  const cFilter = $("categoryFilter").value || "all";
  const defaultVendor = (vFilter !== "all") ? vFilter : "Amazon";
  const defaultCategory = (cFilter !== "all") ? cFilter : "Networking";

  if(defaultVendor && !vendors.some(v=>norm(v)===norm(defaultVendor))) vendors.push(defaultVendor);
  if(defaultCategory && !categories.some(c=>norm(c)===norm(defaultCategory))) categories.push(defaultCategory);

  const idSalt = Math.random().toString(36).slice(2,8);
  const newItem = {
    _id: `NEW-${idSalt}`,
    sku: `NEW-SKU-${idSalt.toUpperCase()}`,
    name: "",
    category: defaultCategory,
    vendor: defaultVendor,
    qty: "",
    notes: "",
    lastOrder: "",
    purchaseUrl: ""
  };
  inventory.unshift(newItem);
  buildFilterOptions();
  scheduleCloudSave();
  render();

  setTimeout(()=>{
    const nameInput = document.querySelector(`input[data-k="name"][data-id="${newItem._id}"]`);
    if(nameInput) nameInput.focus();
  }, 0);
}

/** Render with filters */
function render(){
  const q = norm($("searchInput").value);
  const vFilter = $("vendorFilter").value || "all";
  const cFilter = $("categoryFilter").value || "all";
  const onHandFilter = $("onHandFilter").value || "all";
  const low = Number($("lowStockInput").value || 1);

  const body = $("invBody");
  body.innerHTML = "";
  let shown = 0;

  const rows = inventory.slice().sort((a,b)=> norm(a.name).localeCompare(norm(b.name)));

  rows.forEach(it=>{
    const hay = norm([it.sku,it.name,it.category,it.vendor,it.notes].join(" "));
    if(q && !hay.includes(q)) return;
    if(vFilter !== "all" && it.vendor !== vFilter) return;
    if(cFilter !== "all" && it.category !== cFilter) return;

    const qtyNum = Number(it.qty);
    const qtyBlank = (it.qty === "" || it.qty === null || typeof it.qty === "undefined" || isNaN(qtyNum));
    if(onHandFilter === "unknown" && !qtyBlank) return;
    if(onHandFilter === "in" && (qtyBlank || qtyNum <= 0)) return;
    if(onHandFilter === "out" && (qtyBlank || qtyNum > 0)) return;
    if(onHandFilter === "low" && (qtyBlank || qtyNum <= 0 || qtyNum > low)) return;

    shown++;
    const purchaseLink = getPurchaseUrl(it);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input data-k="sku" data-id="${it._id}" value="${it.sku||""}" style="width:130px"></td>
      <td><input data-k="name" data-id="${it._id}" value="${it.name||""}" style="min-width:280px;width:100%"></td>
      <td>
        <select data-k="category" data-id="${it._id}" style="width:150px">
          ${categoryOptions(it.category || "")}
        </select>
      </td>
      <td>
        <select data-k="vendor" data-id="${it._id}" style="width:150px">
          ${vendorOptions(it.vendor || "")}
        </select>
      </td>
      <td class="nowrap">
        <a class="buy" href="${purchaseLink}" target="_blank" rel="noopener">Purchase</a>
        <button class="tinybtn" data-act="setlink" data-id="${it._id}">Set Link</button>
      </td>
      <td class="nowrap">
        <div class="row" style="gap:6px;">
          <input data-k="qty" data-id="${it._id}" type="number" value="${(it.qty ?? "")}" style="width:80px">
          ${stockBadge(it.qty)}
        </div>
      </td>
      <td><input data-k="notes" data-id="${it._id}" value="${it.notes||""}" style="min-width:220px;width:100%"></td>
      <td><input data-k="lastOrder" data-id="${it._id}" value="${it.lastOrder||""}" style="width:110px"></td>
      <td class="nowrap">
        <button data-act="dup" data-id="${it._id}">Duplicate</button>
        <button data-act="del" data-id="${it._id}" class="bad">Delete</button>
      </td>
    `;
    body.appendChild(tr);
  });

  $("countLabel").textContent = `${shown} shown / ${inventory.length} total`;
}

/** Input edits */
$("invBody").addEventListener("input",(e)=>{
  const t = e.target;
  const id = t.dataset?.id;
  const k  = t.dataset?.k;
  if(!id || !k) return;
  const idx = inventory.findIndex(x=>x._id===id);
  if(idx < 0) return;

  if(k==="qty"){
    inventory[idx][k] = (t.value==="" ? "" : Number(t.value));
  }else{
    inventory[idx][k] = t.value;
  }
  scheduleCloudSave();
});

/** Select changes */
$("invBody").addEventListener("change",(e)=>{
  const t = e.target;
  const id = t.dataset?.id;
  const k  = t.dataset?.k;
  if(!id || !k) return;
  const idx = inventory.findIndex(x=>x._id===id);
  if(idx < 0) return;

  if(k==="vendor" && t.value==="__add_vendor__"){ addVendorFlow(t); return; }
  if(k==="category" && t.value==="__add_category__"){ addCategoryFlow(t); return; }

  inventory[idx][k] = t.value;
  scheduleCloudSave();
  render();
});

/** Row actions */
$("invBody").addEventListener("click",(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const idx = inventory.findIndex(x=>x._id===id);
  if(idx<0) return;

  if(act==="del"){
    inventory.splice(idx,1);
    scheduleCloudSave();
    render();
  }
  if(act==="dup"){
    const copy = {...inventory[idx], _id: `${inventory[idx]._id}-copy-${Math.random().toString(36).slice(2,6)}`};
    inventory.splice(idx+1,0,copy);
    scheduleCloudSave();
    render();
  }
  if(act==="setlink"){
    setDirectLink(id);
  }
});

/** Filter listeners */
$("searchInput").addEventListener("input", render);
$("vendorFilter").addEventListener("change", render);
$("categoryFilter").addEventListener("change", render);
$("onHandFilter").addEventListener("change", render);
$("lowStockInput").addEventListener("input", render);

$("saveBtn").addEventListener("click", ()=>saveLocal(true));

$("resetBtn").addEventListener("click", ()=>{
  if(!confirm("Reset ALL quantities/notes/direct links? Items stay.")) return;
  inventory = inventory.map(it=>({...it, qty:"", notes:"", purchaseUrl:""}));
  scheduleCloudSave();
  render();
});

$("addRowBtn").addEventListener("click", addNewItem);

/** CSV export */
$("exportCsvBtn").addEventListener("click", ()=>{
  const headers = ["sku","name","category","vendor","purchaseUrl","qty","notes","lastOrder"];
  const lines = [headers.join(",")];
  inventory.forEach(it=>{
    const row = headers.map(h => (it[h] ?? "").toString().replaceAll('"','""'));
    lines.push(row.map(v=>`"${v}"`).join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="inventory.csv"; a.click();
  URL.revokeObjectURL(url);
});

/** Download HTML with data */
$("downloadHtmlBtn").addEventListener("click", ()=>{
  const html = document.documentElement.outerHTML;
  const invMarker = /let inventory = \[[\s\S]*?\];/m;
  const venMarker = /let vendors = \[[\s\S]*?\];/m;
  const catMarker = /let categories = \[[\s\S]*?\];/m;

  const injectedInv = `let inventory = ${JSON.stringify(inventory, null, 2)};`;
  const injectedVen = `let vendors = ${JSON.stringify(vendors, null, 2)};`;
  const injectedCat = `let categories = ${JSON.stringify(categories, null, 2)};`;

  const out = html
    .replace(invMarker, injectedInv)
    .replace(venMarker, injectedVen)
    .replace(catMarker, injectedCat);

  const blob = new Blob([out], {type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="bhinv_with_data.html"; a.click();
  URL.revokeObjectURL(url);
});

/** JSON export */
$("downloadJsonBtn").addEventListener("click", ()=>{
  const payload = { vendors, categories, items: inventory };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="inventory.json"; a.click();
  URL.revokeObjectURL(url);
});

/** JSON import */
$("importJsonBtn").addEventListener("click", ()=> $("importJsonInput").click());
$("importJsonInput").addEventListener("change",(e)=>{
  const file = e.target.files?.[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!data || !Array.isArray(data.items)) throw new Error("Invalid JSON format");

      vendors = Array.isArray(data.vendors) ? data.vendors : vendors;
      categories = Array.isArray(data.categories) ? data.categories : categories;
      inventory = data.items;

      ensureIds();
      buildFilterOptions();
      scheduleCloudSave();
      render();
      alert("Inventory imported to cloud!");
    }catch(err){
      alert("Import failed: " + err.message);
    }finally{
      $("importJsonInput").value = "";
    }
  };
  reader.readAsText(file);
});

/** Theme toggle */
$("themeToggleBtn").addEventListener("click", toggleTheme);

/** Init */
(async function init(){
  loadTheme();
  await loadFromSheet();     // cloud is authoritative
  buildFilterOptions();
  render();
})();
</script>
</body>
</html>
